# 알람 시스템 사용 가이드

## 개요

HMI 시스템에 완전한 알람 및 이력 관리 기능이 구현되었습니다. 실제 PLC 연결 시와 동일하게 작동하며, 시뮬레이터를 통해 테스트할 수 있습니다.

## 주요 기능

### 1. 실시간 알람 모니터링 (🔔 알람 메뉴)
- **자동 알람 감지**: 센서 임계값 기반 자동 알람 발생
- **실시간 업데이트**: WebSocket을 통한 1초 간격 업데이트
- **알람 확인 기능**: 확인 버튼으로 알람 ACK 처리
- **알람 요약**: 위험/경고/정보 등급별 카운트

### 2. 알람 이력 조회 (📋 이력 > 알람 이력)
- **전체 알람 이력**: 과거 발생한 모든 알람 조회
- **필터링**: 등급별, 키워드별 검색
- **CSV 내보내기**: 보고서 작성용 데이터 다운로드

### 3. 이벤트 로그 (📋 이력 > 이벤트 로그)
- **제어 명령 기록**: 펌프/팬 시작/정지 등
- **설정 변경 기록**: PLC 레지스터 변경 이력
- **시스템 이벤트**: 시스템 시작/종료 등
- **CSV 내보내기**: 이벤트 로그 다운로드

### 4. 운전 이력 (📋 이력 > 운전 이력)
- **일별 운전 시간**: 장비별 운전 시간 집계
- **에너지 통계**: 소비/절감 전력량
- **리포트 생성**: CSV 형식으로 다운로드

## 알람 임계값 설정

### 온도 알람
| 센서 | 파라미터 | 임계값 | 등급 | 설명 |
|------|---------|--------|------|------|
| T1 | T1_LOW | < 20°C | WARNING | SW Inlet 온도 저하 |
| T1 | T1_HIGH | > 35°C | CRITICAL | SW Inlet 온도 상승 |
| T2 | T2_HIGH | > 75°C | CRITICAL | SW Outlet Main 온도 상승 |
| T3 | T3_HIGH | > 75°C | CRITICAL | SW Outlet Aux 온도 상승 |
| T4 | T4_HIGH | > 55°C | WARNING | FW Inlet 온도 상승 |
| T5 | T5_HIGH | > 40°C | CRITICAL | FW Outlet 온도 상승 |
| T6 | T6_HIGH | > 50°C | CRITICAL | E/R 온도 상승 |
| T7 | T7_HIGH | > 40°C | WARNING | 외기 온도 상승 |

### 압력 알람
| 센서 | 파라미터 | 임계값 | 등급 | 설명 |
|------|---------|--------|------|------|
| PX1 | PX1_LOW | < 1.5 bar | WARNING | SW 압력 저하 |
| PX1 | PX1_HIGH | > 3.0 bar | CRITICAL | SW 압력 상승 |

### 장비 알람
- **EQUIPMENT_FAULT**: 장비 고장 (CRITICAL)
- **VFD_COMM_ERROR**: VFD 통신 오류 (WARNING)
- **VFD_OVERLOAD**: VFD 과부하 (CRITICAL)

## 시뮬레이터 알람 시나리오

시뮬레이터는 다음과 같이 알람을 자동 생성합니다:

### 알람 발생 주기
- **대기 시간**: 60초 (정상 운전)
- **알람 조건**: 10초간 유지
- **복귀**: 자동 정상 복귀

### 테스트 알람 조건
1. **E/R 온도 상승** (T6)
   - 정상: 40°C ± 2°C
   - 알람: 52°C (임계값 50°C 초과)

2. **SW 압력 저하** (PX1)
   - 정상: 3.5 bar ± 0.1 bar
   - 알람: 1.3 bar (임계값 1.5 bar 미만)

## 사용 방법

### 1. 시스템 시작

```bash
# HMI_REAL 폴더에서
START_HMI.bat
```

자동으로 다음이 시작됩니다:
- PLC 시뮬레이터 (포트 502)
- 백엔드 서버 (포트 8000)
- 프론트엔드 (포트 5173)

### 2. 알람 모니터링

1. 브라우저에서 `http://localhost:5173` 접속
2. 상단 메뉴에서 **🔔 알람** 클릭
3. 실시간 알람 상태 확인

#### 알람 발생 확인
- 시뮬레이터 시작 후 **60초 대기**
- 콘솔에 "🔔 알람 시나리오 시작" 메시지 출력
- HMI 화면에 알람 2개 표시:
  - **🔴 E/R Temp High: 52.0°C**
  - **🟡 SW Pressure Low: 1.3 bar**

#### 알람 확인 (ACK)
1. 알람 항목의 **확인** 버튼 클릭
2. 알람 상태가 "확인됨"으로 변경
3. 이벤트 로그에 확인 기록 저장

### 3. 이력 조회

#### 알람 이력
1. **📋 이력** 메뉴 클릭
2. **🔔 알람 이력** 탭 선택
3. 필터 및 검색 사용:
   - **등급 필터**: 전체/위험/경고/정보
   - **키워드 검색**: 알람 메시지 검색
4. **📥 CSV 내보내기** 클릭하여 다운로드

#### 이벤트 로그
1. **📝 이벤트 로그** 탭 선택
2. 이벤트 유형 필터:
   - 제어: 펌프/팬 제어 명령
   - 알람: 알람 발생/확인
   - 설정: 설정값 변경
   - 시스템: 시스템 이벤트
3. **📥 CSV 내보내기**로 다운로드

#### 운전 이력
1. **⚙️ 운전 이력** 탭 선택
2. 조회 기간 설정
3. **🔍 조회** 클릭
4. **📥 리포트 생성**으로 다운로드

### 4. 제어 명령 및 이벤트 로깅

모든 제어 명령은 자동으로 이벤트 로그에 기록됩니다:

1. **⚙️ 펌프 제어** 메뉴에서 SWP1 시작
2. 이벤트 로그에 자동 기록:
   ```
   🎮 제어
   2025-11-12 07:30:15
   Operator
   SWP1 START command executed
   ```

## 데이터 저장 위치

알람 및 이벤트 데이터는 다음 위치에 JSON 형식으로 저장됩니다:

```
HMI_REAL/
└── backend/
    └── data/                      ← 자동 생성
        ├── alarms.json           # 알람 이력
        ├── events.json           # 이벤트 로그
        └── operations.json       # 운전 이력
```

### 데이터 구조 예시

#### alarms.json
```json
{
  "history": [
    {
      "id": "ALM20251112073015001",
      "level": "critical",
      "message": "E/R Temp High: 52.0°C",
      "time": "2025-11-12T07:30:15",
      "acknowledged": true,
      "ack_time": "2025-11-12T07:30:25",
      "ack_user": "Operator",
      "tag": "T6_HIGH",
      "value": 52.0
    }
  ]
}
```

#### events.json
```json
{
  "events": [
    {
      "id": "EVT20251112073020001",
      "time": "2025-11-12T07:30:20",
      "type": "control",
      "user": "Operator",
      "message": "SWP1 START command executed",
      "details": null
    }
  ]
}
```

## API 엔드포인트

백엔드 API는 다음과 같이 사용할 수 있습니다:

### 알람 API

```bash
# 활성 알람 조회
GET http://localhost:8000/api/alarms/active

# 알람 이력 조회
GET http://localhost:8000/api/alarms/history?limit=100&level=critical

# 알람 확인
POST http://localhost:8000/api/alarms/acknowledge
{
  "alarm_id": "ALM20251112073015001",
  "user": "Operator"
}
```

### 이벤트 API

```bash
# 이벤트 로그 조회
GET http://localhost:8000/api/events?limit=100&event_type=control
```

### 운전 이력 API

```bash
# 운전 이력 조회
GET http://localhost:8000/api/operations?start_date=2025-11-01&end_date=2025-11-12
```

## 실제 PLC 연결 시

시뮬레이터 대신 실제 PLC와 연결하려면:

### 1. Backend 설정 변경

[backend/main.py:39](../backend/main.py#L39) 수정:

```python
# 현재 (시뮬레이터)
plc_client = PLCClient(host="192.168.0.130", port=502, slave_id=3, use_simulation=True)

# 실제 PLC 연결
plc_client = PLCClient(host="192.168.0.130", port=502, slave_id=3, use_simulation=False)
```

### 2. 알람 임계값 조정

실제 환경에 맞게 [backend/alarm_manager.py:93-125](../backend/alarm_manager.py#L93-L125)의 임계값을 조정하세요.

### 3. 재시작

```bash
# Backend와 Frontend 재시작
Ctrl+C (각 창에서)
START_HMI.bat
```

## 문제 해결

### 알람이 표시되지 않음
1. 백엔드 콘솔에서 "🔔 새 알람 발생" 메시지 확인
2. 브라우저 개발자 도구(F12) > Console 탭에서 WebSocket 연결 확인
3. `http://localhost:8000/api/alarms/active` 직접 확인

### 이력이 로드되지 않음
1. `backend/data/` 폴더 존재 확인
2. 백엔드 콘솔에서 오류 메시지 확인
3. 브라우저 Console에서 API 요청 오류 확인

### CSV 다운로드 안됨
1. 브라우저 팝업 차단 해제
2. 데이터가 있는지 확인 (최소 1개 이상)

## 테스트 체크리스트

### 알람 시스템
- [ ] 시뮬레이터 시작 후 60초 대기
- [ ] 알람 2개 자동 발생 확인 (E/R 온도, SW 압력)
- [ ] 알람 요약 카운트 정상 표시 (위험:1, 경고:1)
- [ ] 알람 확인 버튼 클릭 → "확인됨" 상태 변경
- [ ] 10초 후 알람 자동 해제 확인

### 이력 관리
- [ ] 알람 이력에 발생한 알람 표시
- [ ] 등급별 필터링 동작
- [ ] 키워드 검색 동작
- [ ] CSV 내보내기 성공 (한글 정상 표시)

### 이벤트 로그
- [ ] 펌프 제어 시 이벤트 로그 기록
- [ ] 알람 확인 시 이벤트 로그 기록
- [ ] 이벤트 유형별 필터링
- [ ] CSV 내보내기 성공

## 참고 자료

- [backend/alarm_manager.py](../backend/alarm_manager.py) - 알람 관리자 소스코드
- [backend/main.py:244-314](../backend/main.py#L244-L314) - 알람 API 엔드포인트
- [frontend/src/components/AlarmPanel.jsx](../frontend/src/components/AlarmPanel.jsx) - 알람 패널 UI
- [frontend/src/components/History.jsx](../frontend/src/components/History.jsx) - 이력 관리 UI

## 향후 개선 사항

1. **데이터베이스 연동**: JSON 파일 대신 SQLite/PostgreSQL 사용
2. **알람 우선순위**: 중요도에 따른 우선순위 설정
3. **알람 사운드**: 위험 알람 발생 시 경고음
4. **푸시 알림**: 모바일/이메일 알림 기능
5. **알람 통계**: 일별/주별/월별 알람 발생 추이
6. **사용자 권한**: 역할별 알람 확인 권한 관리

---

**알람 시스템이 완전히 구현되었으며, 실제 PLC 연결 시와 동일하게 작동합니다!**
