# 알람 시스템 업데이트: 3분 주기 + 다양한 알람 시나리오

## 개요
알람 재발생 간격을 3분(180초)으로 변경하고, 다양한 알람 시나리오를 추가했습니다.

## 주요 변경사항

### 1. 알람 주기 변경
- **기존**: 70초 주기 (60초 정상, 10초 알람)
- **변경**: 180초 주기 (150초 정상, 30초 알람)

### 2. 다양한 알람 시나리오 추가

#### 시나리오 1: E/R 고온 알람 (150~159초)
- **TX6**: 기관실 내부 온도 상승 → 52°C (임계값: 50°C)
- **TX7**: 기관실 외부 온도 상승 → 42°C (임계값: 40°C)
- **알람 레벨**: CRITICAL (위험)

#### 시나리오 2: 냉각수 시스템 이상 (160~169초)
- **TX1**: 냉각수 토출 온도 상승 → 32°C (임계값: 30°C)
- **TX4**: 청수 쿨러 입구 온도 상승 → 52°C (임계값: 50°C)
- **DPX1**: 냉각수 압력 저하 → 1.3 bar (임계값: 1.5 bar 이하)
- **알람 레벨**: CRITICAL + WARNING

#### 시나리오 3: 기관 부하 과다 + 환기 이상 (170~179초)
- **DPX2**: 기관실 차압 이상 → 160 Pa (임계값: 150 Pa)
- **PU1**: 주기관 부하 과다 → 88% (임계값: 85%)
- **알람 레벨**: WARNING

### 3. 추가된 알람 조건

#### 온도 알람
| 센서 | 조건 | 레벨 | 메시지 |
|------|------|------|--------|
| TX1 | > 30°C | CRITICAL | 냉각수 토출 온도 상승 (CSW PP Disc Temp High) |
| TX4 | > 50°C | WARNING | 청수 쿨러 입구 온도 상승 (FW Cooler FW In High) |
| TX6 | > 50°C | CRITICAL | 기관실 내부 온도 상승 (E/R Inside Temp High) |
| TX7 | > 40°C | WARNING | 기관실 외부 온도 상승 (Outside Air Temp High) |

#### 압력 알람
| 센서 | 조건 | 레벨 | 메시지 |
|------|------|------|--------|
| DPX1 | < 1.5 bar | WARNING | 냉각수 압력 저하 (CSW Pressure Low) |
| DPX1 | > 3.0 bar | CRITICAL | 냉각수 압력 과다 (CSW Pressure High) |
| DPX2 | > 150 Pa | WARNING | 기관실 차압 이상 (E/R Diff Press High) |

#### 부하 알람
| 센서 | 조건 | 레벨 | 메시지 |
|------|------|------|--------|
| PU1 | > 85% | WARNING | 주기관 부하 과다 (M/E Load High) |

## 알람 타임라인

```
0초~149초 (2분 30초): 정상 운전
  ├─ 모든 센서 값이 정상 범위 내
  └─ 알람 없음

150초~159초 (10초): 시나리오 1 - E/R 고온 알람
  ├─ TX6 (E/R 내부) 고온: 52°C [CRITICAL]
  ├─ TX7 (E/R 외부) 고온: 42°C [WARNING]
  └─ 경고음 재생 + 알람 버튼 깜박임

160초~169초 (10초): 시나리오 2 - 냉각수 시스템 이상
  ├─ TX1 (냉각수 토출) 고온: 32°C [CRITICAL]
  ├─ TX4 (청수 입구) 고온: 52°C [WARNING]
  ├─ DPX1 (냉각수 압력) 저하: 1.3 bar [WARNING]
  └─ 이전 알람 자동 해제 (조건 정상 복귀)

170초~179초 (10초): 시나리오 3 - 기관 부하 과다 + 환기 이상
  ├─ DPX2 (기관실 차압) 상승: 160 Pa [WARNING]
  ├─ PU1 (주기관 부하) 과다: 88% [WARNING]
  └─ 이전 알람 자동 해제 (조건 정상 복귀)

180초 (0초): 사이클 종료 → 정상 복귀
  ├─ 모든 센서 정상 범위로 복귀
  └─ 미확인 알람은 화면에 유지
```

## 코드 변경 내역

### 1. [backend/modbus_client.py](../backend/modbus_client.py#L487-L562)
**`_get_simulated_sensor_data()` 함수 수정**

```python
def _get_simulated_sensor_data(self) -> Dict[str, Any]:
    """시뮬레이션 센서 데이터 - 실제처럼 변하는 값"""
    elapsed = time.time() - self.sim_start_time

    # 알람 시나리오: 시간 기반 (180초 주기 = 3분)
    # 0~150초: 정상 상태 (2.5분)
    # 150~180초: 다양한 알람 발생 (30초)
    cycle_position = int(elapsed) % 180

    # 알람 상태 전환 시 로그 출력
    if cycle_position == 150 and not self.sim_alarm_active:
        self.sim_alarm_active = True
        logger.warning("=" * 70)
        logger.warning("🔔 [시뮬레이터] 알람 시나리오 시작 (30초간 유지)")
        logger.warning("  - 시나리오 1 (150~160s): E/R 고온 알람")
        logger.warning("  - 시나리오 2 (160~170s): 냉각수 압력 저하 + 온도 이상")
        logger.warning("  - 시나리오 3 (170~180s): 기관 부하 과다 + E/R 차압 이상")
        logger.warning("=" * 70)
```

**다양한 알람 시나리오 구현**:
- 시나리오별로 다른 센서가 비정상 값을 가짐
- 각 시나리오는 10초씩 순차적으로 발생
- 이전 시나리오의 알람은 자동 해제됨

### 2. [backend/alarm_manager.py](../backend/alarm_manager.py#L103-L131)
**`_load_alarm_config()` 함수 수정**

추가된 알람 설정:
```python
# 온도 알람에 한국어 메시지 추가
"T1_HIGH": {"level": AlarmLevel.CRITICAL, "threshold": 30,
            "message": "냉각수 토출 온도 상승 (CSW PP Disc Temp High)"},
"T4_HIGH": {"level": AlarmLevel.WARNING, "threshold": 50,
            "message": "청수 쿨러 입구 온도 상승 (FW Cooler FW In High)"},
"T6_HIGH": {"level": AlarmLevel.CRITICAL, "threshold": 50,
            "message": "기관실 내부 온도 상승 (E/R Inside Temp High)"},
"T7_HIGH": {"level": AlarmLevel.WARNING, "threshold": 40,
            "message": "기관실 외부 온도 상승 (Outside Air Temp High)"},

# 압력 알람 추가
"PX2_HIGH": {"level": AlarmLevel.WARNING, "threshold": 150,
             "message": "기관실 차압 이상 (E/R Diff Press High)"},

# 부하 알람 추가
"PU1_HIGH": {"level": AlarmLevel.WARNING, "threshold": 85,
             "message": "주기관 부하 과다 (M/E Load High)"},
```

### 3. [backend/alarm_manager.py](../backend/alarm_manager.py#L247-L291)
**`check_sensor_alarms()` 함수에 체크 로직 추가**

```python
# E/R 차압 체크 (DPX2)
px2 = sensors.get("DPX2")  # E/R Diff Press (Pa)
if px2 is not None:
    alarm_tag = "PX2_HIGH"
    if px2 > self.alarm_config["PX2_HIGH"]["threshold"]:
        # 알람 조건 - 새 알람 추가
        if alarm_tag not in self.active_alarms:
            config = self.alarm_config["PX2_HIGH"]
            alarm = Alarm(
                id=self._generate_alarm_id(),
                level=config["level"],
                message=f"{config['message']}: {px2:.1f} Pa",
                time=current_time,
                tag=alarm_tag,
                value=px2
            )
            new_alarms.append(alarm)
            self.active_alarms[alarm_tag] = alarm
    else:
        # 정상 조건 - 기존 알람 자동 해제
        if alarm_tag in self.active_alarms:
            self.clear_alarm(alarm_tag)

# 기관 부하 체크 (PU1)
pu1 = sensors.get("PU1")  # M/E Load (%)
if pu1 is not None:
    alarm_tag = "PU1_HIGH"
    if pu1 > self.alarm_config["PU1_HIGH"]["threshold"]:
        # 알람 발생 로직
    else:
        # 알람 해제 로직
```

## 테스트 방법

### 1. HMI 시스템 시작
```bash
START_HMI.bat
```

또는 수동으로:
```bash
# 터미널 1: 백엔드
cd backend
python main.py

# 터미널 2: 프론트엔드
cd frontend
npm run dev
```

### 2. 브라우저 접속
http://localhost:5173

### 3. 알람 관찰

#### 150초 대기 (2분 30초)
- 정상 운전 상태 확인
- 모든 센서 값이 안정적

#### 150~160초: 시나리오 1
- 🔔 알람 버튼이 빨간색으로 깜박임
- 경고음 (삐삐삐) 3회 재생
- 알람 패널에 2개 알람 표시:
  - "기관실 내부 온도 상승 (E/R Inside Temp High): 52.0°C" 🔴
  - "기관실 외부 온도 상승 (Outside Air Temp High): 42.0°C" 🟡

#### 160~170초: 시나리오 2
- 이전 알람 자동 해제 (조건 정상 복귀)
- 새로운 알람 3개 발생:
  - "냉각수 토출 온도 상승 (CSW PP Disc Temp High): 32.0°C" 🔴
  - "청수 쿨러 입구 온도 상승 (FW Cooler FW In High): 52.0°C" 🟡
  - "냉각수 압력 저하 (CSW Pressure Low): 1.30 bar" 🟡

#### 170~180초: 시나리오 3
- 이전 알람 자동 해제
- 새로운 알람 2개 발생:
  - "기관실 차압 이상 (E/R Diff Press High): 160.0 Pa" 🟡
  - "주기관 부하 과다 (M/E Load High): 88.0%" 🟡

#### 180초 (사이클 종료)
- 모든 알람 조건 해제
- **미확인 알람은 화면에 유지** (사용자가 확인할 때까지)
- 확인된 알람만 이력으로 이동

### 4. 알람 확인 테스트
- "확인" 버튼 클릭
- 알람이 이력으로 이동
- 알람 버튼 깜박임 중지 (모든 알람 확인 시)

## 알람 동작 특징

### 1. 자동 해제 (Auto-Clear)
- 센서 값이 정상 범위로 복귀하면 알람 조건 해제
- **단, 미확인 알람은 화면에 유지**
- 사용자가 "확인" 버튼을 눌러야 이력으로 이동

### 2. 경고음
- 새로운 알람 발생 시에만 재생
- 880Hz 사인파, 200ms × 3회
- 볼륨: 30%

### 3. 시각 효과
- 🔔 알람 버튼: 빨간색 깜박임 (1.5초 주기)
- 알람 리스트: 깜박임 없음 (가독성 향상)
- CRITICAL 알람: 두꺼운 테두리 (3px)

### 4. 알람 레벨
- 🔴 **CRITICAL**: 위험 (즉시 대응 필요)
- 🟡 **WARNING**: 경고 (주의 필요)
- 🟢 **INFO**: 정보 (참고용)

## 백엔드 로그 확인

알람 시나리오 시작 시 콘솔 로그:
```
======================================================================
🔔 [시뮬레이터] 알람 시나리오 시작 (30초간 유지)
  - 시나리오 1 (150~160s): E/R 고온 알람
  - 시나리오 2 (160~170s): 냉각수 압력 저하 + 온도 이상
  - 시나리오 3 (170~180s): 기관 부하 과다 + E/R 차압 이상
======================================================================
```

알람 종료 시:
```
✅ [시뮬레이터] 알람 시나리오 종료 (정상 복귀)
```

## 알람 이력 확인

### 이력 메뉴에서 확인 가능한 정보
- 알람 발생 시각
- 알람 레벨 및 메시지
- 센서 값
- 확인 시각
- 확인자 (사용자 또는 System)

### 이력 조회
- 📋 이력 메뉴 클릭
- 최근 100개 알람 표시
- 시간순 정렬 (최신순)

## 문제 해결

### 알람이 발생하지 않아요
1. 백엔드가 시뮬레이션 모드로 실행 중인지 확인
2. 백엔드 콘솔에서 150초 경과 확인
3. 브라우저 콘솔(F12)에서 WebSocket 연결 상태 확인

### 경고음이 들리지 않아요
1. 브라우저 탭을 한 번 클릭 (자동재생 정책)
2. 시스템 볼륨 확인
3. 브라우저 음소거 해제

### 알람 버튼이 깜박이지 않아요
1. 브라우저 캐시 삭제 (Ctrl+Shift+R)
2. 미확인 알람이 있는지 확인
3. CSS 파일이 로드되었는지 확인

## 관련 파일

- [backend/modbus_client.py](../backend/modbus_client.py) - 시뮬레이터 센서 데이터 생성
- [backend/alarm_manager.py](../backend/alarm_manager.py) - 알람 감지 및 관리
- [frontend/src/App.jsx](../frontend/src/App.jsx) - 알람 버튼 깜박임
- [frontend/src/App.css](../frontend/src/App.css) - 알람 버튼 애니메이션
- [frontend/src/components/AlarmPanel.jsx](../frontend/src/components/AlarmPanel.jsx) - 알람 패널 및 경고음
- [frontend/src/components/AlarmPanel.css](../frontend/src/components/AlarmPanel.css) - 알람 패널 스타일

## 관련 문서

- [알람_경고음_및_시각효과_가이드.md](알람_경고음_및_시각효과_가이드.md)
- [알람_시스템_사용_가이드.md](알람_시스템_사용_가이드.md)
- [알람_시스템_테스트_결과.md](알람_시스템_테스트_결과.md)

---

**작성일**: 2025-11-12
**버전**: 2.0
**작성자**: Claude Code
**주요 변경**: 3분 주기 + 다양한 알람 시나리오 추가
