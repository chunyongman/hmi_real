# ✅ HMI_WEB_NEW 시스템 완료 보고서

## 📋 작업 개요

참조 프로그램 (`C:\Users\my\Desktop\HMI\ess-hmi-web`)을 기반으로 Unayzah Express M-Class 선박의 ESS HMI 시스템을 구축했습니다.

**프로젝트 위치:** `C:\Users\my\Desktop\Unayzah Exp_HMI(100Pa_241219)N\HMI_WEB_NEW`

---

## ✨ 주요 변경 사항

### 1. 백엔드 수정 (Python FastAPI)

#### 📄 `backend/modbus_client.py` - 완전 재작성
**변경 이유:** 참조 프로그램은 6개 펌프만 지원, 현재 시스템은 10개 장비 (6 펌프 + 4 팬) 필요

**주요 수정:**
- ✅ 센서 데이터 읽기 (K400010-K400019)
  - TX1-TX7: 온도 센서 (7개)
  - DPX1-DPX2: 압력 센서 (2개)
  - PU1: M/E 부하 센서

- ✅ 장비 상태 읽기 (K4000-K4001)
  - 펌프: SWP1-3, FWP1-3 (RUN, ESS, ABNR 비트)
  - 팬: FAN1-4 (RUNFW, RUNBW, ABNR 비트)

- ✅ VFD 데이터 읽기 (K400160-K400238)
  - 각 장비당 8개 레지스터
  - 10개 장비 지원

- ✅ 장비 제어 명령 (Coil 64064~)
  - START/STOP 명령 (모든 장비)
  - FWD/BWD 명령 (팬 전용)

#### 📄 `backend/main.py` - 10개 장비 지원
**변경 사항:**
- ✅ `/api/equipment` - 모든 장비 (10개)
- ✅ `/api/pumps` - 펌프만 (6개)
- ✅ `/api/fans` - 팬만 (4개) **[신규]**
- ✅ `/api/equipment/command` - 통합 제어 API
- ✅ WebSocket 실시간 브로드캐스트 (1초 간격)

### 2. 프론트엔드 수정 (React + Vite)

#### 📄 `frontend/src/App.jsx`
**변경 사항:**
- ✅ `equipment` 상태 추가 (10개 장비 전체)
- ✅ `fans` 상태 추가 (4개 팬)
- ✅ `sendEquipmentCommand()` 함수 - 새로운 API 사용
- ✅ "🌀 팬 제어" 탭 추가
- ✅ 모든 컴포넌트에 팬 데이터 전달

#### 📄 `frontend/src/components/PumpControl.jsx`
**변경 사항:**
- ✅ `isFanMode` 속성 지원
- ✅ 팬 제어 UI (FWD/BWD/STOP 버튼)
- ✅ 팬 상태 표시 (정방향/역방향/정지)
- ✅ 장비명 기반 제어로 변경

### 3. 시뮬레이터

#### 📄 `simulator/plc_simulator.py`
**상태:** ✅ 이미 복사됨 (이전 작업에서)
- 10개 장비 시뮬레이션 지원
- 실시간 센서 데이터 생성
- 제어 명령 처리

### 4. 배치 파일

#### 📄 `START_HMI.bat`
**수정 사항:**
- ✅ 정확한 포트 정보
  - PLC: 192.168.0.130:502
  - 백엔드: http://localhost:8000
  - 프론트엔드: http://localhost:5173
- ✅ 자동 브라우저 실행 (10초 지연)

#### 📄 `STOP_HMI.bat`
**상태:** ✅ 이미 존재

---

## 📁 수정된 파일 목록

```
✅ backend/modbus_client.py         - 완전 재작성 (10개 장비)
✅ backend/main.py                  - API 엔드포인트 수정
✅ frontend/src/App.jsx             - 팬 제어 추가
✅ frontend/src/components/PumpControl.jsx - 팬 모드 지원
✅ START_HMI.bat                    - 포트 정보 수정
✅ README.md                        - 문서 업데이트
📝 테스트_가이드.md                  - 신규 작성
📝 완료_보고서.md                    - 이 문서
```

---

## 🎯 시스템 사양

### 선박 정보
- **선박명:** Unayzah Express
- **선박 등급:** M-Class
- **E/R 압력 기준:** 100Pa

### 장비 구성
- **Sea Water Pumps:** SWP1, SWP2, SWP3
- **Fresh Water Pumps:** FWP1, FWP2, FWP3
- **E/R Fans:** FAN1, FAN2, FAN3, FAN4

### 센서 구성
- **온도 센서 (7개):**
  - TX1: CSW PP Disc Temp
  - TX2: CSW PP Suc Temp
  - TX3: FW CLNG In Temp
  - TX4: FW CLNG Out Temp
  - TX5: ESS Batt Temp
  - TX6: E/R Inside Temp
  - TX7: E/R Outside Temp

- **압력 센서 (2개):**
  - DPX1: CSW PP Disc Press (kg/cm²)
  - DPX2: E/R Diff Press (Pa)

- **부하 센서 (1개):**
  - PU1: M/E Load (%)

### PLC 통신
- **프로토콜:** Modbus TCP
- **IP 주소:** 192.168.0.130
- **포트:** 502
- **Slave ID:** 3

---

## 🎨 화면 구성

1. **📊 대시보드** - 시스템 전체 개요
2. **🔧 배관 계통도** - SVG 다이어그램
3. **⚙️ 펌프 제어** - 6개 펌프 제어 (SWP, FWP)
4. **🌀 팬 제어** - 4개 팬 제어 (FWD/BWD) **[신규]**
5. **🎛️ 고급 제어** - 통합 제어
6. **⚙️ 설정** - 시스템 설정
7. **📈 트렌드** - 실시간 차트
8. **📋 이력** - 히스토리
9. **🔔 알람** - 알람 패널

---

## 🚀 사용 방법

### 1️⃣ 시스템 시작

```batch
START_HMI.bat
```

**자동 실행 내용:**
1. PLC 시뮬레이터 시작 (192.168.0.130:502)
2. 백엔드 서버 시작 (포트 8000)
3. 프론트엔드 서버 시작 (포트 5173)
4. 10초 후 브라우저 자동 실행

### 2️⃣ HMI 사용

1. **브라우저 접속:** http://localhost:5173
2. **펌프 제어:**
   - "⚙️ 펌프 제어" 탭 클릭
   - 원하는 펌프 선택
   - "▶️ 시작" 또는 "⏸️ 정지" 버튼 클릭

3. **팬 제어:**
   - "🌀 팬 제어" 탭 클릭
   - 원하는 팬 선택
   - "▶️ 정방향", "◀️ 역방향", "⏸️ 정지" 버튼 클릭

### 3️⃣ 시스템 종료

```batch
STOP_HMI.bat
```

또는 각 창에서 `Ctrl+C` 입력

---

## 🔍 테스트 방법

자세한 테스트 절차는 **`테스트_가이드.md`** 파일을 참조하세요.

**간단 테스트:**
1. `START_HMI.bat` 실행
2. 브라우저에서 http://localhost:5173 접속
3. 펌프 또는 팬 제어 테스트
4. 센서 데이터 실시간 업데이트 확인

---

## 📊 API 엔드포인트

### REST API
- `GET /api` - API 정보
- `GET /api/status` - 시스템 상태
- `GET /api/sensors` - 센서 데이터
- `GET /api/equipment` - 모든 장비 (10개)
- `GET /api/pumps` - 펌프만 (6개)
- `GET /api/fans` - 팬만 (4개) **[신규]**
- `POST /api/equipment/command` - 장비 제어 **[신규]**

### WebSocket
- `WS /ws` - 실시간 데이터 (1초 간격)

**메시지 형식:**
```json
{
  "type": "realtime_update",
  "sensors": { TX1, TX2, ..., PU1 },
  "equipment": [ 10개 장비 ],
  "pumps": [ 6개 펌프 ],
  "timestamp": "2025-01-01T12:00:00"
}
```

---

## 🎯 참조 프로그램과의 차이점

| 항목 | 참조 프로그램 | 현재 시스템 |
|-----|-------------|-----------|
| 펌프 개수 | 6개 (SWP1-3, FWP1-3) | 6개 (동일) |
| 팬 개수 | 0개 | **4개 (FAN1-4)** ⭐ |
| 총 장비 | 6개 | **10개** |
| 팬 제어 | 없음 | **FWD/BWD 제어** ⭐ |
| 온도 센서 | TX1-TX5B (5개) | **TX1-TX7 (7개)** ⭐ |
| 압력 센서 | PX1 (1개) | **DPX1-DPX2 (2개)** ⭐ |
| VFD 데이터 | 6개 장비 | **10개 장비** ⭐ |
| 제어 API | `/api/pump/command` | `/api/equipment/command` ⭐ |

---

## ✅ 작업 완료 항목

### 백엔드
- [x] modbus_client.py 완전 재작성
- [x] 10개 장비 지원 (6 펌프 + 4 팬)
- [x] 센서 데이터 읽기 (TX1-TX7, DPX1-DPX2, PU1)
- [x] 장비 상태 읽기 (K4000-K4001)
- [x] VFD 데이터 읽기 (K400160-K400238)
- [x] 장비 제어 명령 (START/STOP/FWD/BWD)
- [x] main.py API 엔드포인트 수정
- [x] WebSocket 실시간 브로드캐스트

### 프론트엔드
- [x] App.jsx - 팬 데이터 상태 추가
- [x] App.jsx - 팬 제어 탭 추가
- [x] App.jsx - sendEquipmentCommand() 구현
- [x] PumpControl.jsx - 팬 모드 지원
- [x] PumpControl.jsx - FWD/BWD 버튼 추가
- [x] 모든 컴포넌트에 팬 데이터 전달

### 시뮬레이터
- [x] plc_simulator.py 복사 (10개 장비 지원)

### 배치 파일
- [x] START_HMI.bat 포트 정보 수정
- [x] STOP_HMI.bat 확인

### 문서
- [x] README.md 업데이트
- [x] 테스트_가이드.md 작성
- [x] 완료_보고서.md 작성 (이 문서)

---

## 🔧 기술 스택

### 백엔드
- **Python 3.8+**
- **FastAPI** - 웹 프레임워크
- **Uvicorn** - ASGI 서버
- **pymodbus** - Modbus TCP 클라이언트
- **WebSocket** - 실시간 통신

### 프론트엔드
- **React 18** - UI 라이브러리
- **Vite** - 빌드 도구
- **CSS3** - HMI 스타일링

### 시뮬레이터
- **Python 3.8+**
- **pymodbus** - Modbus TCP 서버
- **threading** - 멀티스레드

---

## 📝 다음 단계 (선택 사항)

### 추가 개선 가능 항목
- [ ] Dashboard 컴포넌트 팬 데이터 표시 강화
- [ ] DynamicSVGDiagram에 팬 4개 추가
- [ ] TrendChart에 팬 데이터 추가
- [ ] 알람 시스템 구현
- [ ] 히스토리 데이터베이스 연동
- [ ] 사용자 인증 시스템
- [ ] 에너지 절감 보고서 기능

### 실제 PLC 연동 시
- [ ] PLC IP 주소 확인 (현재: 192.168.0.130)
- [ ] Modbus 레지스터 주소 검증
- [ ] 실제 장비와 제어 명령 테스트
- [ ] 센서 값 범위 보정
- [ ] 알람 임계값 설정

---

## 🎉 완료 요약

**참조 프로그램을 기반으로 Unayzah Express M-Class 선박의 ESS HMI 시스템이 성공적으로 구축되었습니다!**

**주요 성과:**
- ✅ 10개 장비 지원 (6 펌프 + 4 팬)
- ✅ 팬 양방향 제어 (FWD/BWD)
- ✅ 7개 온도 센서, 2개 압력 센서 지원
- ✅ 실시간 WebSocket 통신
- ✅ PLC 시뮬레이터 통합
- ✅ 완전한 문서화

**시스템 준비 완료!** 🚀

---

**작성일:** 2025-01-29
**버전:** 2.0.0
**프로젝트:** HMI_WEB_NEW (Unayzah Express M-Class)
